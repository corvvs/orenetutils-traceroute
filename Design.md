# ft_traceroute 設計ドキュメント

## traceroute とは

現在のホストから目的のホストまで, ネットワークパケットがどのような経路で転送されていくのかを調査するためのコマンド。

### 動作原理

おおまかには以下の3つを前提としている, はず:

- IPパケットはTTLが0まで減少すると破棄されること
- その際, ICMP TimeExceededデータグラムが送信元に投げ返されること
- プローブ(目的のホストに向かって送信されるパケット)が目的のホストに到達した場合, ICMP Port Unreachable が送信元に投げ返されること

### メカニズム

Src(ソース)からDst(デスティネーション)に向けて, ネットワークパケットを送る。\
パケットは通常UDPデータグラムだが, ICMP Echoが使われることもある。

送るパケットのIP TTLを仮に`t`とすると, パケットがSrcからDstまでルーティングされる途中でTTLが0になった場合,\
すなわち`t`回ネットワークホップした時点でそのホストがDst出ない場合, パケットは破棄される。\
そしてこの時, *大抵の場合は* **ICMP TimeExceededデータグラム**がSrcに向けて返送される。

返送されたICMP TimeExceededの送信元 = パケットが破棄されたホストを`t`の順に並べることで,
パケットの経路上のホストがわかることになる。

## 用語

- ソース(Src)
  - 調べたい転送経路の始点となるアドレス。
  - プローブの送信元。
- デスティネーション(Dst)
  - 調べたい転送経路の終点となるアドレス。
  - プローブの宛先。
- プローブ
  - 転送経路を調べるために実際に送信されるパケットのこと。
- ホップ
  - パケット(データグラム)があるネットワークから別のネットワークに移動すること。
  - 転じて、プローブのTTLを`t`にした時の一連の処理についても「ホップ」と呼ぶ。
- TTL
  - IPヘッダが持つ整数値。ホップ1回ごとに1つずつ減少し, 0になったらIPデータグラムはそれ以上転送されずに破棄される。
- UDP
  - 何も指定がなければ, プローブはUDPデータグラムになる。
- ICMP
  - IPに付随して, ネットワークのエラー通知や通信の制御を行うためのプロトコル。
  - 実装によっては, オプションによりプローブをICMP Echoとすることもある。
    - その場合, Dst到達時に投げ返されるのがICMP Echo Replyになる。
- ICMP Time Exceeded
  - IPデータグラムがTTL=0になったことで破棄された際, IPデータグラムの送信元に対して投げ返される(ことのある)ICMPデータグラム。
  - ICMP Type = 11, Code = 0
- ICMP Port Unreachable
  - IPデータグラムは宛先ホストに到達したが, 宛先ホストにおいて目的のポートが開いていないときに生成される。
  - ICMP Type = 3, Code = 3

## プログラムの構造

### 入力

IPv4アドレスまたはホスト名を1つ受け取る。

### traceroute セッション

入力1つに対して, 以下の一連の処理を**traceroute セッション**と呼ぶことにする。

1. 宛先やプローブに関する情報を表示する
2. `t = 1 .. max_hop`について, 以下の処理を繰り返し実行する
    1. 以下を`hop_tried`回繰り返す
        1. Dstに向けて, IP TTLを`t`にセットしたUDPデータグラムを送信する.
        2. 受信を待機する
            - タイムアウト
                - `*`を表示
            - 受信成功
                - 受け取ったものが ICMP Time Exceeded
                    - ラウンドトリップを`ms`単位で表示
                - 受け取ったものが ICMP Port Unreachable
                    - ラウンドトリップを`ms`単位で表示
                    - どう違うんだっけか
    2. 送信元がDstに等しいデータグラムを1つでも受信しているならセッション終了

## ラフな構造

### メインフロー

1. オプション解析
2. ソケット作成
3. 各ホストについて**tracerouteセッション**を実行

### tracerouteセッション

1. ホストからIPアドレスを取得
2. `t = 1 .. max_hop`について, **ホップセッション**を実行
    - ホップセッションにおいてDstからのデータグラムかICMP Destination Unreachableタイプデータグラムを受け取った場合はtracerouteセッションを終了する

### ホップセッション

1. **ホップラウンド**を`hop_tried`回繰り返す
    - オプションによってはこれを並列で行う
    - その場合は ping と同じ手が使えそう
    - 最初から並列前提で作ろう

### ホップラウンド

1. 送信処理
    - Dstに向けて, IP TTLを`t`にセットしたUDPデータグラムを送信する.
2. 受信処理
    - タイムアウト
        - `*`を表示
    - 受信成功
        - 受け取ったものが ICMP Time Exceeded
            - ラウンドトリップを`ms`単位で表示
        - 受け取ったものが ICMP Port Unreachable
            - ラウンドトリップを`ms`単位で表示
            - どう違うんだっけか

## 実装方針

### 全体に関するコメント

- シングルプロセス・シングルスレッド
- mallocするとこなさそう
    - あるかも。ホップサイズ。

### エラーについて

- エラーが出た場合, なるべく出てすぐにエラーメッセージを出す
- ソケット作成, ソケットオプション設定におけるエラーはプログラムを終了させる
- パケット送受信におけるエラーはtracerouteセッションを終了させる
- 想定外のパケットを受信した場合の挙動はまた定義していない

### プローブについて

プローブとして使うデータグラムの種類に応じてやるべきことが変わってくる。

|プローブ|返送:Dst到達前|返送:Dst到達時|
|--|--|--|
|UDP|ICMP Time Exceeded|ICMP Port Unreachable|
|ICMP Echo|ICMP Time Exceeded|ICMP Echo Reply|

### 対応するオプションについて

|オプション|意味|パラメータ|詳細|
|-|-|-|-|
|`-i`|送信元インターフェース|インターフェース名||
|`-m`|最大ホップ数|1-255||
|`-p`|Dstポート番号|ポート番号またはサービス名||
|`-s`|送信元アドレス|IPv4アドレスまたはホスト名||
|`-q`|ホップあたりのプローブ送信数|1-10||
|`-N`|ホップあたりのプローブ並列数|unsigned int(0は1と同じ)||
|`-t`|IP ToS|0-255||
|`-l`|受信パケットのTTL表示|なし||

### ICMPデータグラムの種類(関係ありそうなやつのみ)

|名前|Type|Code|詳細|
|-|:-:|:-:|-|
|**Echo**|8|0| オプションによってはプローブとして送信される |
|**Echo Reply**|0|0| Echoがプローブの場合, Dst到達時にこれが返送される |
|Network Unreachable|3|0|Dstがあるネットワークへのルーティングが不可能な時に返送される|
|Host Unreachable|3|1|DstのネットワークにはいけるがDstそのものには到達できない時に返送される|
|Protocol Unreachable|3|2|Dstがプローブのプロトコルをサポートしていない時に返送される|
|**Port Unreachable**|3|3|Dstの指定したポートが開いていない時に返送される; UDPがプローブの場合, Dst送達時にこれが返送される|
|Source Quench|4|0|スルーして良さそう|
|Redirect Message|5|0-3|スルーして良さそう|
|**Time to Live exceeded in Transit**|11|0|転送中にTTLが0に達した時に返送される|
|Fragment Reassembly Time Exceeded|11|1|あんま関係なさそう|
